{% extends "base.html" %}
{% block content %}

<script>
    document.body.classList.add("myfiles-body");
</script>

<div class="myfiles-shell">
    <aside class="side-rail">
        <button type="button" class="upload-btn" onclick="window.location.href='/myfiles'">Upload File</button>

        <nav class="rail-nav">
            <button class="rail-link active" type="button" onclick="window.location.href='/myfiles'">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                My files
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
                Shared with me
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Recent
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Bin
            </button>
        </nav>
    </aside>

    <section class="main-stage">
        <div class="workspace">
            <div class="file-detail-container">
                <div class="detail-header">
                    <button class="back-btn" onclick="window.location.href='/myfiles'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back to My Files
                    </button>
                </div>

                <div class="detail-content">
                    <div class="file-preview-card">
                        <div class="file-icon-large">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="file-metadata">
                            <div class="meta-row">
                                <span class="meta-label">Name of file:</span>
                                <span class="meta-value">{{ file.name }}</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Uploaded by:</span>
                                <span class="meta-value">{{ file.uploaded_by }}</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Owner:</span>
                                <span class="meta-value">{{ file.owner }}</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Date Uploaded:</span>
                                <span class="meta-value">{{ file.modified }}</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <input type="file" id="version-input" class="visually-hidden" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.txt">
                            <button class="action-btn secondary-btn" id="upload-version-btn">Upload new version</button>
                            <a href="{{ file.url }}" download class="action-btn primary-btn">Download File</a>
                        </div>
                    </div>

                    <div class="history-section">
                        <h3 class="history-title">History:</h3>
                        <div class="history-table">
                            <div class="history-head">
                                <div class="hist-col">Name</div>
                                <div class="hist-col">Uploaded by</div>
                                <div class="hist-col">Date Uploaded</div>
                                <div class="hist-col"></div>
                            </div>
                            <div class="history-body">
                                {% if versions %}
                                    {% for v in versions|reverse %}
                                    <div class="history-row">
                                        <div class="hist-col">{{ v.name }}{% if v.is_current %} (Current){% else %} (v{{ v.version }}){% endif %}</div>
                                        <div class="hist-col">{{ v.uploaded_by }}</div>
                                        <div class="hist-col">{{ v.date }}</div>
                                        <div class="hist-col actions">
                                            <button class="action-dots" 
                                                data-filename="{% if v.is_current %}{{ file.name }}{% else %}{{ v.version_file or (file.name.rsplit('.', 1)[0] + '_v' + v.version|string + '.' + file.name.rsplit('.', 1)[1]) }}{% endif %}" 
                                                data-download-url="{% if v.is_current %}{{ file.url }}{% else %}{{ url_for('download_version', filename=v.version_file or (file.name.rsplit('.', 1)[0] + '_v' + v.version|string + '.' + file.name.rsplit('.', 1)[1])) }}{% endif %}" 
                                                data-is-current="{{ v.is_current }}" 
                                                data-version="{{ v.version }}">···</button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="history-row">
                                        <div class="hist-col" style="grid-column: 1 / -1; text-align: center; color: #888;">No version history yet</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<div id="file-menu" class="file-menu" style="display: none;">
    <button class="menu-item" data-action="download">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download
    </button>
    <button class="menu-item" data-action="rename">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Rename
    </button>
    <button class="menu-item" data-action="share">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        Share
    </button>
    <button class="menu-item menu-item-danger" data-action="delete">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
        Delete
    </button>
</div>

<!-- Toast Notification -->
<div id="toast-notification" style="position: fixed; bottom: 20px; right: 20px; background-color: #4caf50; color: white; padding: 16px 24px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 10000; display: none; animation: slideIn 0.3s ease-in; font-weight: 500;">
    Link copied successfully!
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; padding: 30px; border-radius: 12px;">
        <h2 id="share-modal-title" style="margin-bottom: 25px; font-size: 18px; font-weight: 600; color: #222;">Send the link for <span id="share-filename" style="font-weight: 700;"></span></h2>
        
        <div style="margin-bottom: 18px;">
            <input type="email" id="share-email-input" placeholder="Add people to share file to" 
                   style="width: 100%; padding: 14px 15px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; background-color: #f9f9f9; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        </div>
        
        <div style="margin-bottom: 28px;">
            <input type="password" id="share-password-input" placeholder="Set password (optional)" 
                   style="width: 100%; padding: 14px 15px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; background-color: #f9f9f9; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        </div>
        
        <div style="display: flex; justify-content: flex-start; align-items: center; gap: 15px;">
            <button id="copy-link-btn" style="display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: white; border: 1px solid #d0d0d0; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; color: #333; transition: all 0.2s;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                Copy link
            </button>
            <div style="display: flex; gap: 12px; margin-left: auto;">
                <button id="cancel-share-btn" style="padding: 10px 24px; background: white; border: 1px solid #d0d0d0; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; color: #333; transition: all 0.2s;">Cancel</button>
                <button id="send-share-btn" style="padding: 10px 28px; background: #4a90e2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;">Send</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-in;
}

.modal-content {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

#copy-link-btn:hover, #cancel-share-btn:hover {
    background-color: #f5f5f5;
    border-color: #999;
}

#send-share-btn:hover {
    background-color: #3d7bc4;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>

<script>
    const uploadVersionBtn = document.getElementById('upload-version-btn');
    const versionInput = document.getElementById('version-input');
    const filename = "{{ file.name }}";
    const tenantId = new URLSearchParams(window.location.search).get('tenant') || '1';

    uploadVersionBtn.addEventListener('click', () => {
        versionInput.click();
    });

    versionInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('tenant', tenantId);

        try {
            uploadVersionBtn.disabled = true;
            uploadVersionBtn.textContent = 'Uploading...';

            const response = await fetch(`/upload/version/temp/${encodeURIComponent(filename)}?tenant=${tenantId}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.confirm_url) {
                window.location.href = data.confirm_url;
            } else {
                alert(data.error || 'Upload failed');
                uploadVersionBtn.disabled = false;
                uploadVersionBtn.textContent = 'Upload new version';
            }
        } catch (err) {
            alert('Upload failed. Please try again.');
            uploadVersionBtn.disabled = false;
            uploadVersionBtn.textContent = 'Upload new version';
        }

        versionInput.value = '';
    });

    // File menu handlers (same as myfiles.html)
    const fileMenu = document.getElementById("file-menu");
    let currentFileName = null;
    let currentDownloadUrl = null;
    let currentIsCurrent = null;
    let currentVersion = null;

    const showFileMenu = (event, filename, downloadUrl, isCurrent, version) => {
        currentFileName = filename;
        currentDownloadUrl = downloadUrl;
        currentIsCurrent = isCurrent;
        currentVersion = version;
        fileMenu.style.display = "block";
        const x = event.clientX;
        const y = event.clientY;
        fileMenu.style.top = `${y + window.scrollY}px`;
        fileMenu.style.left = `${x + window.scrollX - 150}px`;
    };

    const hideFileMenu = () => {
        fileMenu.style.display = "none";
        currentFileName = null;
        currentDownloadUrl = null;
        currentIsCurrent = null;
        currentVersion = null;
    };

    document.addEventListener("click", (event) => {
        if (event.target.closest(".action-dots")) {
            event.stopPropagation();
            const btn = event.target.closest(".action-dots");
            showFileMenu(
                event,
                btn.dataset.filename,
                btn.dataset.downloadUrl,
                btn.dataset.isCurrent === 'True',
                btn.dataset.version
            );
        } else if (!event.target.closest(".file-menu")) {
            hideFileMenu();
        }
    });

    // Right-click context menu for history rows
    const historyBody = document.querySelector('.history-body');
    if (historyBody) {
        historyBody.addEventListener("contextmenu", (event) => {
            const row = event.target.closest(".history-row");
            if (!row) return;
            event.preventDefault();
            
            const btn = row.querySelector(".action-dots");
            if (btn) {
                showFileMenu(
                    event,
                    btn.dataset.filename,
                    btn.dataset.downloadUrl,
                    btn.dataset.isCurrent === 'True',
                    btn.dataset.version
                );
            }
        });
    }

    fileMenu.addEventListener("click", async (event) => {
        const menuItem = event.target.closest(".menu-item");
        if (!menuItem) return;

        const action = menuItem.dataset.action;
        const tenantId = new URLSearchParams(window.location.search).get('tenant') || '1';

        if (action === "download") {
            window.location.href = currentDownloadUrl;
        } else if (action === "rename") {
            const newName = prompt("Enter new filename:", currentFileName);
            if (newName && newName !== currentFileName) {
                try {
                    const response = await fetch(`/rename?tenant=${tenantId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ old_name: currentFileName, new_name: newName })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert(data.message || "File renamed successfully");
                        location.reload();
                    } else {
                        alert(data.error || "Rename failed");
                    }
                } catch (err) {
                    alert("Rename failed");
                }
            }
        } else if (action === "delete") {
            if (confirm(`Are you sure you want to delete this ${currentIsCurrent ? 'file' : 'version'}?`)) {
                if (currentIsCurrent) {
                    try {
                        const response = await fetch(`/delete?tenant=${tenantId}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ filename: currentFileName })
                        });
                        const data = await response.json();
                        if (response.ok) {
                            alert(data.message || "File deleted successfully");
                            window.location.href = `/myfiles?tenant=${tenantId}`;
                        } else {
                            alert(data.error || "Delete failed");
                        }
                    } catch (err) {
                        alert("Delete failed");
                    }
                } else {
                    alert("Version deletion coming soon");
                }
            }
        } else if (action === "share") {
            // Show share modal
            showShareModal(currentFileName, tenantId);
        }

        hideFileMenu();
    });

    // Share modal functionality
    const shareModal = document.getElementById("share-modal");
    const shareFilenameEl = document.getElementById("share-filename");
    const shareEmailInput = document.getElementById("share-email-input");
    const sharePasswordInput = document.getElementById("share-password-input");
    const copyLinkBtn = document.getElementById("copy-link-btn");
    const cancelShareBtn = document.getElementById("cancel-share-btn");
    const sendShareBtn = document.getElementById("send-share-btn");
    let currentShareLink = null;
    let currentShareFilename = null;
    let currentShareTenant = null;

    const showShareModal = (filename, tenant) => {
        currentShareFilename = filename;
        currentShareTenant = tenant;
        shareFilenameEl.textContent = filename;
        shareEmailInput.value = "";
        sharePasswordInput.value = "";
        currentShareLink = null;
        shareModal.style.display = "flex";
    };

    const hideShareModal = () => {
        shareModal.style.display = "none";
        currentShareLink = null;
        currentShareFilename = null;
        currentShareTenant = null;
    };

    const generateShareLink = async () => {
        try {
            const response = await fetch('/generate_share_link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    filename: currentShareFilename,
                    tenant: currentShareTenant,
                    password: sharePasswordInput.value || null
                })
            });
            const data = await response.json();
            if (response.ok) {
                currentShareLink = data.share_link;
                return data.share_link;
            } else {
                alert(data.error || "Failed to generate share link");
                return null;
            }
        } catch (err) {
            alert("Failed to generate share link");
            return null;
        }
    };

    copyLinkBtn.addEventListener("click", async () => {
        if (!currentShareLink) {
            currentShareLink = await generateShareLink();
        }
        if (currentShareLink) {
            navigator.clipboard.writeText(currentShareLink).then(() => {
                const toast = document.getElementById("toast-notification");
                toast.style.display = "block";
                setTimeout(() => {
                    toast.style.display = "none";
                }, 3000);
            }).catch(() => {
                prompt("Copy this share link:", currentShareLink);
            });
        }
    });

    cancelShareBtn.addEventListener("click", () => {
        hideShareModal();
    });

    sendShareBtn.addEventListener("click", async () => {
        const email = shareEmailInput.value.trim();
        
        if (!currentShareLink) {
            currentShareLink = await generateShareLink();
        }
        
        if (!currentShareLink) return;

        if (email) {
            // Send email with share link
            try {
                const response = await fetch('/send_share_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        share_link: currentShareLink,
                        filename: currentShareFilename
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    alert("Share link sent successfully!");
                    hideShareModal();
                } else {
                    alert(data.error || "Failed to send email");
                }
            } catch (err) {
                alert("Failed to send email");
            }
        } else {
            // Just copy the link
            navigator.clipboard.writeText(currentShareLink).then(() => {
                alert("Share link copied to clipboard!");
                hideShareModal();
            }).catch(() => {
                prompt("Copy this share link:", currentShareLink);
                hideShareModal();
            });
        }
    });

    // Close modal when clicking outside
    shareModal.addEventListener("click", (e) => {
        if (e.target === shareModal) {
            hideShareModal();
        }
    });
</script>

{% endblock %}
