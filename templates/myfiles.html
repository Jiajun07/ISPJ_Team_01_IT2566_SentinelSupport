{% extends "base.html" %}
{% block content %}

<script>
    document.body.classList.add("myfiles-body");
</script>

<div class="myfiles-shell">
    <aside class="side-rail">
        <button type="button" class="upload-btn" id="upload-trigger">Upload File</button>

        <nav class="rail-nav">
            <button class="rail-link active" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                My files
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
                Shared with me
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Recent
            </button>
            <button class="rail-link" type="button">
                <svg class="rail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Bin
            </button>
        </nav>

        <form id="upload-form" class="upload-form" aria-label="Upload files">
            <input
                type="file"
                id="file-input"
                name="file"
                class="file-input visually-hidden"
                accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.txt"
                required
            >
            <div id="message" class="message"></div>
            <button type="submit" class="visually-hidden">Upload</button>
        </form>
    </aside>

    <section class="main-stage">

        <div class="workspace">
            <div class="search-row">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" class="search-icon" aria-hidden="true">
                        <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2" />
                        <line x1="16" y1="16" x2="21" y2="21" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <input id="file-search" type="search" placeholder="Search files" aria-label="Search files">
                </div>
            </div>

            <div class="table-card">
                <div class="table-head">
                    <div class="col name">Name</div>
                    <div class="col">Sensitivity</div>
                    <div class="col">Owner</div>
                    <div class="col">Date Modified</div>
                    <div class="col size">File Size</div>
                    <div class="col actions"></div>
                </div>
                <div id="file-list" class="table-body">
                    <div class="empty-state">No files yet. Upload one to see it here.</div>
                </div>
            </div>
        </div>
    </section>
</div>

<div id="drag-overlay" class="drag-overlay" aria-hidden="true">
    <div class="drag-overlay-card">
        <div class="drag-overlay-icon">⬆</div>
        <div class="drag-overlay-text">Drop files to upload</div>
        <div class="drag-overlay-allowed">Allowed: PDF, DOC/DOCX, PNG, JPG/JPEG, TXT</div>
    </div>
</div>

<div id="file-menu" class="file-menu" style="display: none;">
    <button class="menu-item" data-action="download">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download
    </button>
    <button class="menu-item" data-action="rename">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Rename
    </button>
    <button class="menu-item" data-action="share">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        Share
    </button>
    <button class="menu-item menu-item-danger" data-action="delete">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
        Delete
    </button>
</div>

<script>
    const allowedExtensions = ["pdf", "doc", "docx", "png", "jpg", "jpeg", "txt"];
    const existingFiles = {{ files | tojson | safe }};
    const form = document.getElementById("upload-form");
    const uploadTrigger = document.getElementById("upload-trigger");
    const fileInput = document.getElementById("file-input");
    const messageEl = document.getElementById("message");
    const fileList = document.getElementById("file-list");
    const searchInput = document.getElementById("file-search");

    const formatSize = (bytes = 0) => {
        if (!bytes) return "-";
        const units = ["B", "KB", "MB", "GB"];
        const power = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        const size = bytes / Math.pow(1024, power);
        return `${size.toFixed(1)} ${units[power]}`;
    };

    const showMessage = (text, type) => {
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
    };

    const ensureBodyState = () => {
        if (!document.body.classList.contains("myfiles-body")) {
            document.body.classList.add("myfiles-body");
        }
    };

    const addFileRow = (file) => {
        const row = document.createElement("div");
        row.className = "table-row";

        const owner = file.owner || "You";
        const modified = file.modified || "-";
        const sensitivity = file.sensitivity || "-";
        const hashText = file.hash ? `SHA256: ${file.hash}` : "Checksum pending";

        row.dataset.search = `${file.name} ${owner} ${sensitivity}`.toLowerCase();
        row.dataset.filename = file.name;
        row.dataset.url = file.url;

        row.innerHTML = `
            <div class="col name">
                <a class="file-link" href="/file/${encodeURIComponent(file.name)}">${file.name}</a>
                <div class="file-subtext">${hashText}</div>
            </div>
            <div class="col">${sensitivity}</div>
            <div class="col">${owner}</div>
            <div class="col">${modified}</div>
            <div class="col size">${formatSize(file.size)}</div>
            <div class="col actions" aria-label="Actions">
                <button class="action-dots" data-filename="${file.name}" data-url="${file.url}">···</button>
            </div>
        `;

        fileList.appendChild(row);
    };

    const clearEmptyState = () => {
        const empty = fileList.querySelector(".empty-state");
        if (empty) {
            empty.remove();
        }
    };

    const handleUpload = async (file) => {
        const ext = file.name.split(".").pop().toLowerCase();
        if (!allowedExtensions.includes(ext)) {
            showMessage("Invalid file type. Please choose a supported format.", "error");
            fileInput.value = "";
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("/upload/temp", { method: "POST", body: formData });
            const data = await response.json();

            if (!response.ok || data.error) {
                showMessage(data.error || `Upload failed (status ${response.status}).`, "error");
                return;
            }

            if (data.confirm_url) {
                window.location.href = data.confirm_url;
            } else {
                showMessage("Upload succeeded but no confirm URL returned.", "error");
            }
        } catch (err) {
            showMessage("Upload failed. Please try again.", "error");
        }
    };

    const applySearch = () => {
        const term = (searchInput.value || "").toLowerCase();
        const rows = [...fileList.querySelectorAll(".table-row")];
        let matches = 0;

        rows.forEach((row) => {
            const match = row.dataset.search.includes(term);
            row.style.display = match ? "grid" : "none";
            if (match) matches += 1;
        });

        const emptyState = fileList.querySelector(".empty-state");
        if (!rows.length && !emptyState) {
            fileList.innerHTML = '<div class="empty-state">No files yet. Upload one to see it here.</div>';
        } else if (rows.length && matches === 0) {
            if (emptyState) {
                emptyState.textContent = "No files match your search.";
                emptyState.style.display = "block";
            } else {
                const div = document.createElement("div");
                div.className = "empty-state";
                div.textContent = "No files match your search.";
                fileList.appendChild(div);
            }
        } else if (matches > 0 && emptyState) {
            emptyState.style.display = "none";
        }
    };

    form.addEventListener("submit", (event) => {
        event.preventDefault();
        const file = fileInput.files[0];
        if (!file) {
            showMessage("Please pick a file to upload.", "error");
            return;
        }
        handleUpload(file);
    });

    uploadTrigger.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            handleUpload(file);
        }
    });

    const dragOverlay = document.getElementById("drag-overlay");
    let dragCounter = 0;

    const showOverlay = () => {
        dragOverlay.classList.add("visible");
    };

    const hideOverlay = () => {
        dragOverlay.classList.remove("visible");
    };

    window.addEventListener("dragenter", (event) => {
        event.preventDefault();
        dragCounter += 1;
        showOverlay();
    });

    window.addEventListener("dragover", (event) => {
        event.preventDefault();
    });

    window.addEventListener("dragleave", (event) => {
        event.preventDefault();
        dragCounter = Math.max(0, dragCounter - 1);
        if (dragCounter === 0) {
            hideOverlay();
        }
    });

    window.addEventListener("drop", (event) => {
        event.preventDefault();
        dragCounter = 0;
        hideOverlay();
        const file = event.dataTransfer.files && event.dataTransfer.files[0];
        if (!file) return;
        handleUpload(file);
    });

    // File menu handlers
    const fileMenu = document.getElementById("file-menu");
    let currentFileName = null;
    let currentFileUrl = null;

    const showFileMenu = (event, filename, url) => {
        currentFileName = filename;
        currentFileUrl = url;
        fileMenu.style.display = "block";
        const x = event.clientX;
        const y = event.clientY;
        fileMenu.style.top = `${y + window.scrollY}px`;
        fileMenu.style.left = `${x + window.scrollX - 150}px`;
    };

    const hideFileMenu = () => {
        fileMenu.style.display = "none";
        currentFileName = null;
        currentFileUrl = null;
    };

    document.addEventListener("click", (event) => {
        if (event.target.closest(".action-dots")) {
            event.stopPropagation();
            const btn = event.target.closest(".action-dots");
            showFileMenu(event, btn.dataset.filename, btn.dataset.url);
        } else if (!event.target.closest(".file-menu")) {
            hideFileMenu();
        }
    });

    fileList.addEventListener("contextmenu", (event) => {
        const row = event.target.closest(".table-row");
        if (!row) return;
        event.preventDefault();
        showFileMenu(event, row.dataset.filename, row.dataset.url);
    });

    fileMenu.addEventListener("click", async (event) => {
        const menuItem = event.target.closest(".menu-item");
        if (!menuItem) return;

        const action = menuItem.dataset.action;

        if (action === "download") {
            window.location.href = currentFileUrl;
        } else if (action === "rename") {
            const newName = prompt("Enter new filename:", currentFileName);
            if (newName && newName !== currentFileName) {
                try {
                    const response = await fetch("/rename", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ old_name: currentFileName, new_name: newName })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage(data.message || "File renamed successfully", "success");
                        location.reload();
                    } else {
                        showMessage(data.error || "Rename failed", "error");
                    }
                } catch (err) {
                    showMessage("Rename failed", "error");
                }
            }
        } else if (action === "share") {
            const email = prompt("Enter email address to share with:");
            if (email) {
                try {
                    const response = await fetch("/share", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ filename: currentFileName, email: email })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage(data.message || "File shared successfully", "success");
                    } else {
                        showMessage(data.error || "Share failed", "error");
                    }
                } catch (err) {
                    showMessage("Share failed", "error");
                }
            }
        } else if (action === "delete") {
            if (confirm(`Are you sure you want to delete "${currentFileName}"?`)) {
                try {
                    const response = await fetch("/delete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ filename: currentFileName })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage(data.message || "File deleted successfully", "success");
                        location.reload();
                    } else {
                        showMessage(data.error || "Delete failed", "error");
                    }
                } catch (err) {
                    showMessage("Delete failed", "error");
                }
            }
        }

        hideFileMenu();
    });

    const renderExistingFiles = () => {
        if (!existingFiles || !existingFiles.length) return;
        fileList.innerHTML = "";
        existingFiles.forEach(addFileRow);
    };

    ensureBodyState();
    renderExistingFiles();
    applySearch();
    searchInput.addEventListener("input", applySearch);
</script>
{% endblock %}
